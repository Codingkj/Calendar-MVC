<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>KK Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="stylesheet.css">

  <script src="http://code.jquery.com/jquery-2.1.4.min.js"> </script>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="../../jquery-ui-1.11.4/jquery-ui.css">
  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="../../jquery-ui-1.11.4/jquery-ui.js"></script>
  
  <script src="View.js"></script>
  <script src="ViewForms.js"></script>
  <script src="ViewEvents.js"></script>
  <script src="Model.js"></script>
  <script src="Utilities.js"></script>

</head>
<body>

 <script src="http://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true">
   </script>
  <script>


$(function controllerSupremo(){  
    var $dateSelected = "";  
    var $locationsArray= [];
    var $bodyElement = $('body');
    var $gridElement = $('#grid');
    var $currentMonthNumber = Utilities.getCurrentMonthNumber();
    var $currentMonthName = Utilities.getMonthName($currentMonthNumber); 
    var $currentYearNumber = Utilities.getYearNumber(); 
    View.createPageHeader($currentMonthName, $currentYearNumber,$bodyElement);
    View.createGridOfDatesView($bodyElement);
    Model.createWeekdayLabelCells($gridElement);
   // createInitialPageView(currentMonthName);

    var $dayHeaderCells = Model.getWeekdayCells();
    var $weekdayLabels = Model.getWeekdayLabels();

    View.setWeekdayLabelsToColumns($dayHeaderCells, $weekdayLabels);
    var $numDaysInMonth = Utilities.getDatesInCurrentMonth($currentYearNumber,$currentMonthNumber);
    
    var $taskEntryArray = Model.initialiseTaskStorageArray($numDaysInMonth);
    Model.initialiseLocationsStorageArray($locationsArray);
    
    var $startCell = Model.getStartCell($currentMonthName);
    
    var $daysToUse = Model.setBlanksAtStartOfMonth($currentMonthName,$startCell); 
    
    var $daysToUseWithBlanksAdded = Model.setNumbersToRestOfMonth($currentMonthName,$daysToUse,$numDaysInMonth,$startCell);   
     
    var $allCellsForDates = View.setArrayValuesToTablePosition($daysToUseWithBlanksAdded);   
  
    var $dateToHighlight = Utilities.findTodaysDate(); 
  
    View.setTodayHighlight($dateToHighlight);
    ViewForms.createTaskEntryForm($bodyElement);
    ViewForms.createTaskEditForm($bodyElement);
    ViewForms.createMapView($bodyElement);
  //  addMarksToSlider();
  
  //  .on( "click", handler )

    $('.todaysdate').on('click',ViewEvents.showClickedOnDate);
    $('.active').on('click',ViewEvents.showClickedOnDate);

    $('#submitbutton').on('click',ViewEvents.saveTaskEntry);
    $('#cancelbutton').on('click',ViewEvents.cancelTaskEntry);
    $('#closebutton').on('click',ViewEvents.closeEditForm);  
    $('#editbutton').on('click',ViewEvents.showEditForm);
    $('#removebutton').on('click',ViewEvents.removeTask); 
    $('#gobackbutton').on('click',ViewEvents.returnToCalendarScreen);

    $( "#findbutton" ).on('click',ViewEvents.findPostcode);

// function addCalendarClickListener(selector,callback)
//$('body').on('click','['+selector+'],function(clickevent){
//    var currentday = $(this).attr(selector);
//   callback(currentday);
// });

    $("#mapViewButton").click(function () {   // to display all tasks on 1 map
        event.preventDefault(); 
        event.stopPropagation();
        console.log("got here too!!!!");
        View.showMapView();
        View.displayStarterMap(51.5,-0.8);
      
        $ (function createSlider()  {
        
        $("#slider-range").slider({
          range: true,
          min: 1,
          max: 30,       //should be days in the month
          values:[1,20], 
          step:1,
      
            slide: function onSliderMove( event, ui ) {
                      $( "#slidevalue" ).val(ui.values[ 0 ] + " - " + ui.values[ 1 ] + ' '+ $currentMonthName);
                   },
            start: function( event, ui ) {
                      $( "#startvalue" ).val(ui.values[ 0 ] + " - " + ui.values[ 1 ] );
                   },
            stop: function onSliderStop( event, ui ) {
                    View.clearTasksInSliderView();

                    $( "#stopvalue" ).val(ui.values[ 0 ] + " - " + ui.values[ 1 ] ); 
                        
                    var $marker; 
                    var counter = 1;
                    var infowindow = new google.maps.InfoWindow();   
                    var $map;
                    var tasksInRange = Model.getNumberOfTasksInRange(ui.values[0],ui.values[1]);           
                    $lineBr=$('<br></br>');
                    $taskShortDiv = $('#taskDiv');
                    $taskShortDiv.append($lineBr);
                    $taskSummary = $('<p>There are '+ tasksInRange +' tasks in this range:</p>');
                    $taskShortDiv.append($taskSummary);
            
                    for (var $dateIterator=ui.values[0];$dateIterator<ui.values[1]+1; $dateIterator++){
                        var $dateWithTask = Model.getExistingTask($dateIterator);
                        if ($dateWithTask !== ""){
                            console.log("date iterator is now",$dateIterator);

                            var $coords = Model.getExistingLocation($dateIterator);
                            var $latitude = $coords[0];
                            var $longitude = $coords[1];
                            $mapContainer = $('#mapSummaryDiv');
                           
                            console.log("Passed to map",$latitude,$longitude,$mapContainer);
                            if (counter = 1) {
                                $map = Utilities.createGoogleMap2($latitude,$longitude,$mapContainer);
                                counter = 2;
                            }
                            $marker = Utilities.createMapMarker($latitude,$longitude,$map);
                               
                            View.displayTasksInSelection($dateIterator, ui.values[0],ui.values[1]);
                           
                            var numTasks = numTasks+1;

                      //    View.addListenerToMap
                            
                            google.maps.event.addListener($marker, 'click', (function($marker, $dateIterator) { 
                                    return function() {
                                      var content = Model.getExistingTask($dateIterator);
                                      infowindow.setContent(content);
                                      infowindow.open($map, $marker);
                                    }
                            })($marker,$dateIterator));  //end of Listener
                        }   //end of if loop
                       }   //end of for loop
                    },  //end of slider stop function
                }); //end of .slider function
             
      });  //end of  slider functionality function call
    });  //end of mapView


});

</script>
</body>
</html>